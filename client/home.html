<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://momentjs.com/downloads/moment.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <title>Sensors</title>
    <script type="text/javascript">
        $.get("latest-event", function (response, status) {
            var { data } = response
            var tbody = document.querySelector(".latest-event");
            var template = document.querySelector('#tableRowLatestEvent');
            var clone = template.content.cloneNode(true);
            var tdDate = clone.querySelectorAll(".date");
            var tdSensor1 = clone.querySelectorAll(".sensor1");
            var tdSensor2 = clone.querySelectorAll(".sensor2");
            var tdSensor3 = clone.querySelectorAll(".sensor3");
            var tdSensor4 = clone.querySelectorAll(".sensor4");
            var save = clone.querySelectorAll(".save");
            save[0].addEventListener("click", () => {
                axios.post('last-event', data)
                    .then(function (response) {
                        if (response.status == 201) {
                            loadEventHistory()
                        }
                        else if (response.status == 200) {
                            alert(response.data.message)
                        }
                    })
                    .catch(function (error) {
                        console.log(error);
                    });

            }, false);

            tdDate[0].textContent = moment(data.date).format("DD.MM.YYYY HH:mm")
            if (data.sensor1)
                tdSensor1[0].textContent = Number.parseFloat(data.sensor1).toFixed(2)
            if (data.sensor2)
                tdSensor2[0].textContent = Number.parseFloat(data.sensor2).toFixed(2)
            if (data.sensor3)
                tdSensor3[0].textContent = Number.parseFloat(data.sensor3).toFixed(2)
            if (data.sensor4)
                tdSensor4[0].textContent = Number.parseFloat(data.sensor4).toFixed(2)
            tbody.appendChild(clone);
        });

        loadEventHistory()

        function loadEventHistory() {
            $.get("last-event", function (response, status) {
                var data = response
                var tbody = document.querySelector(".last-event");
                $(".last-event").empty()
                response.map(data => {
                    var template = document.querySelector('#tableRowHistoryEvents');
                    var clone = template.content.cloneNode(true);
                    var tdDate = clone.querySelectorAll(".date");
                    var tdSensor1 = clone.querySelectorAll(".sensor1");
                    var tdSensor2 = clone.querySelectorAll(".sensor2");
                    var tdSensor3 = clone.querySelectorAll(".sensor3");
                    var tdSensor4 = clone.querySelectorAll(".sensor4");
                    var remove = clone.querySelectorAll(".remove");
                    remove[0].addEventListener("click", () => {
                        var r = confirm("Are you sure you want to remove this event?");
                        if (!r) return
                        axios.delete('last-event/' + data._id)
                            .then(function (response) {
                                loadEventHistory()
                            })
                            .catch(function (error) {
                                console.log(error);
                            });
                    }, false);
                    tdDate[0].textContent = moment(data.date).format("DD.MM.YYYY HH:mm")
                    if (data.sensor1)
                        tdSensor1[0].textContent = Number.parseFloat(data.sensor1).toFixed(2)
                    if (data.sensor2)
                        tdSensor2[0].textContent = Number.parseFloat(data.sensor2).toFixed(2)
                    if (data.sensor3)
                        tdSensor3[0].textContent = Number.parseFloat(data.sensor3).toFixed(2)
                    if (data.sensor4)
                        tdSensor4[0].textContent = Number.parseFloat(data.sensor4).toFixed(2)
                    tbody.appendChild(clone);
                })
            })
        }

    </script>
</head>
<body>
    <div class='container' style="margin-top: 30px;">
        <h3>Latest event</h3>
        <div class="table-responsive">
            <table id="table" class="table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Sensor 1</th>
                        <th>Sensor 2</th>
                        <th>Sensor 3</th>
                        <th>Sensor 4</th>
                        <th>Options</th>
                    </tr>
                </thead>
                <tbody class="latest-event">
                </tbody>
            </table>
        </div>
        <h3>Last events</h3>
        <div class="table-responsive">
            <table id="last-event" class="table table-bordered ">
                <thead>
                    <tr class="bg-light">
                        <th>Date</th>
                        <th>Sensor 1</th>
                        <th>Sensor 2</th>
                        <th>Sensor 3</th>
                        <th>Sensor 4</th>
                        <th>Options</th>
                    </tr>
                </thead>
                <tbody class="last-event">
                </tbody>
            </table>
        </div>
    </div>
    <template id="tableRowLatestEvent">
        <tr>
            <td class="date"></td>
            <td class="sensor1"></td>
            <td class="sensor2"></td>
            <td class="sensor3"></td>
            <td class="sensor4"></td>
            <td><button class="btn btn-sm btn-primary save">Save</button></td>
        </tr>
    </template>
    <template id="tableRowHistoryEvents">
        <tr>
            <td class="date"></td>
            <td class="sensor1"></td>
            <td class="sensor2"></td>
            <td class="sensor3"></td>
            <td class="sensor4"></td>
            <td><button class="btn btn-sm btn-danger remove">Remove</button></td>
        </tr>
    </template>
</body>
</html>